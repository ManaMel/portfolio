<div id="<%= dom_id(recording) %>" class="p-4 bg-base-200 rounded-xl shadow mb-6">
  
  <div class="flex justify-between items-start mb-3">
    <h3 class="text-xl font-semibold text-green-900"><%= recording.title %></h3>
    
    <%# 録音全消しボタン %>
    <%= link_to recording_path(recording),
        data: { turbo_method: :delete, turbo_confirm: "録音をすべて削除しますか？" } do %>
      <div class="flex items-center text-red-500 hover:text-red-700 text-sm font-medium ml-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 6h6v10H7V6z" clip-rule="evenodd" />
        </svg>
        <span class="ml-1">削除</span>
      </div>
    <% end %>
  </div>

  <%# --- ステータス表示ロジック --- %>
  <% status_class = case recording.status
    when 'completed' then 'bg-green-100 text-green-800'
    when 'failed' then 'bg-red-100 text-red-800'
    when 'mixing' then 'bg-yellow-100 text-yellow-800 animate-pulse'
    else 'bg-gray-100 text-gray-600'
  end %>

  <%# リアルタイムで更新されるステータス部分 %>
  <div class="flex items-center mb-4">
    <span class="inline-block px-3 py-1 text-sm font-medium rounded-full <%= status_class %>">
      <%= t("recording_statuses.#{recording.status}", default: recording.status.humanize) %>
    </span>
    <% if recording.status == 'failed' && recording.error_message.present? %>
      <p class="text-sm text-red-600 ml-3">エラー: <%= recording.error_message %></p>
    <% end %>
    <%# 処理中のアニメーションは status_class の animate-pulse で実現されるため、
       強制リロードボタンは不要になりました。 %>
  </div>
  
  <%# --- 元の録音 --- %>
  <p class="font-bold text-base mt-2">元の録音</p>
  <div class="flex items-center space-x-2">
    <% if recording.original_audio.attached? %>
      <audio controls class="mt-1 w-full flex-grow">
        <source src="<%= url_for(recording.original_audio) %>">
      </audio>
      <%= link_to destroy_original_recording_path(recording),
          data: { turbo_method: :delete, turbo_confirm: "元音声削除しますか？" } do %>
        <div class="text-red-400 hover:text-red-600">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 6h6v10H7V6z" clip-rule="evenodd" /></svg>
        </div>
      <% end %>
    <% else %>
      <p class="text-sm text-gray-500">元音声なし</p>
    <% end %>
  </div>


  <%# --- 伴奏 --- %>
  <p class="font-bold text-base mt-4">伴奏ファイル</p>
  <div class="flex items-center space-x-2">
    <% if recording.accompaniment.attached? %>
      <audio controls class="mt-1 w-full flex-grow">
        <source src="<%= url_for(recording.accompaniment) %>">
      </audio>
      <%= link_to destroy_accompaniment_recording_path(recording),
          data: { turbo_method: :delete, turbo_confirm: "伴奏削除しますか？" } do %>
        <div class="text-red-400 hover:text-red-600">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 6h6v10H7V6z" clip-rule="evenodd" /></svg>
        </div>
      <% end %>
    <% else %>
      <%= link_to "伴奏を選ぶ", select_accompaniment_recording_path(recording), class: "btn btn-sm btn-info mt-2" %>
    <% end %>
  </div>


  <%# --- ミックス済み音声 (生成後) --- %>
  <p class="font-bold text-base mt-4">ミックス済み音声</p>
  <div class="flex items-center space-x-2">
    <% if recording.generated_audio.attached? %>
      <audio controls class="mt-2 w-full flex-grow">
        <source src="<%= url_for(recording.generated_audio) %>" type="<%= recording.generated_audio.content_type %>">
      </audio>
      <%= link_to destroy_generated_recording_path(recording),
          data: { turbo_method: :delete, turbo_confirm: "生成音削除しますか？" } do %>
        <div class="text-red-400 hover:text-red-600">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 6h6v10H7V6z" clip-rule="evenodd" /></svg>
        </div>
      <% end %>
    <% else %>
      <p class="text-sm text-gray-500">まだ生成されていません</p>
    <% end %>
  </div>
  
  <%# --- 調整ページへの誘導リンク (新規追加) --- %>
  <div class="mt-4 text-center">
    <%= link_to "ディレイ・ゲインを調整する", recording_path(recording), class: "py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md text-sm font-medium inline-block" %>
  </div>

  <%# --- 音声生成フォーム (調整値を使用しない場合、または調整後すぐに実行したい場合) --- %>
  <div class="mt-3">
    <%# 注意: generate_audio_recording_path は POST リクエストを受け取ることを前提とします %>
    <%= form_with url: generate_audio_recording_path(recording), method: :post, local: true, data: { turbo: true } do %>
      <%# 伴奏がなければボタンを無効化（ここはビジネスロジックに応じて調整してください） %>
      <% is_disabled = !recording.original_audio.attached? || !recording.accompaniment.attached? %>

      <% if recording.status == 'mixing' %>
        <%# 処理中はボタンを非活性化 %>
        <%= submit_tag "生成中...", class: "btn btn-sm btn-warning mt-2", disabled: true %>
      <% elsif recording.generated_audio.attached? %>
        <%= submit_tag "再生成する", class: "btn btn-sm btn-warning mt-2 #{'opacity-50 cursor-not-allowed' if is_disabled}", disabled: is_disabled %>
      <% else %>
        <%= submit_tag "音声を生成する", class: "btn btn-primary btn-sm mt-2 #{'opacity-50 cursor-not-allowed' if is_disabled}", disabled: is_disabled %>
      <% end %>
      
      <% if is_disabled %>
        <p class="text-xs text-red-500 mt-1">※ 元音声と伴奏の両方が必要です。</p>
      <% end %>
    <% end %>
  </div>
</div>