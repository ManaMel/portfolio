<%# app/views/recordings/new.html.erb %>

<%= render 'layouts/header' %>

<div class="max-w-3xl mx-auto mt-8 space-y-6 text-green-900 text-lg text-center items-center">

  <h1 class="font-bold text-2xl">♪ 歌声や演奏を録音 ♪</h1>

  <!-- 録音操作ボタン -->
  <div class="flex justify-center gap-4">
    <button type="button" id="buttonStart" class="bg-green-800 text-white rounded px-4 py-2 disabled:bg-gray-400">録音開始</button>
    <button type="button" id="buttonStop" class="bg-red-800 text-white rounded px-4 py-2 disabled:bg-gray-400" disabled>録音停止</button>
    <button type="button" id="buttonPlay" class="bg-pink-800 text-white rounded px-4 py-2 disabled:bg-gray-400">再生</button>
  </div>

  <!-- 波形表示 -->
  <div id="waveform" class="my-4"></div>

  <!-- エフェクト調整 -->
  <div class="max-w-xl mx-auto mt-6 p-6 bg-base-200 rounded-2xl shadow-lg space-y-4">
    <h2 class="text-xl font-bold text-center">エフェクト調整</h2>
    <div class="form-control">
      <label class="label"><span class="label-text font-semibold">音量</span></label>
      <input id="volumeSlider" type="range" min="0" max="2" value="1" step="0.01" class="range range-success">
    </div>
    <div class="form-control">
      <label class="label"><span class="label-text font-semibold">リバーブ（残響）</span></label>
      <input id="reverbSlider" type="range" min="0" max="1" value="0" step="0.01" class="range range-primary">
    </div>
    <div class="form-control">
      <label class="label"><span class="label-text font-semibold">エコーの遅延時間（秒）</span></label>
      <input id="echoDelay" type="range" min="0" max="1.0" value="0.25" step="0.01" class="range range-warning">
    </div>
    <div class="form-control">
      <label class="label"><span class="label-text font-semibold">エコーの反射量（フィードバック）</span></label>
      <input id="echoFeedback" type="range" min="0" max="1.0" value="0.3" step="0.01" class="range range-error">
    </div>
  </div>

  <!-- 録音保存フォーム -->
  <div class="max-w-lg mx-auto mt-8 card bg-base-200 p-6 rounded-2xl shadow-lg space-y-4">
    <h2 class="text-xl font-bold mb-4">録音を保存</h2>

    <%= form_with url: recordings_path, method: :post, local: true, html: { id: "recording-form" } do |f| %>
      <div class="mb-4">
        <label class="label"><span class="label-text font-semibold">タイトル</span></label>
        <input name="recording[title]" id="recording-title" type="text" placeholder="例：サビだけ録音" class="input input-bordered w-full" required>
      </div>

      <%= f.hidden_field :original_audio, id: "recording-file-hidden" %>

      <div class="mb-4 text-sm opacity-70" id="recording-info">※ まだ録音データが未取得です</div>

      <%= f.submit "保存する", class: "btn btn-primary btn-block", id: "save-recording-btn", disabled: true %>
    <% end %>

    <button id="generate-audio-btn" class="btn btn-success btn-block" disabled>音声生成する</button>

    <div class="mt-4 text-center">
      <%= link_to "自分の録音を確認する", mypage_path, class: "btn btn-outline btn-wide btn-warning" %>
    </div>
  </div>
</div>

<%= f.hidden_field :original_audio, id: "recording-file-hidden" %>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const saveBtn = document.getElementById("save-recording-btn");

  // 録音停止後に保存ボタンを有効化
  const observer = new MutationObserver(() => {
    if (window.latestRecordingBlob) saveBtn.disabled = false;
  });
  observer.observe(document.getElementById("recording-info"), { childList: true });

  // 保存フォーム送信時に加工済み音声を hidden input にセット
  document.getElementById("recording-form").addEventListener("submit", (e) => {
    if (!window.processedAudioBuffer && !window.latestRecordingBlob) {
      e.preventDefault();
      alert("録音データがありません");
      return;
    }

    // Web Audio エフェクト適用済みのバッファを優先
    const buffer = window.processedAudioBuffer || window.latestRecordingBlobBuffer;
    const blob = buffer instanceof Blob ? buffer : audioBufferToWavBlob(buffer);

    const fileInput = document.getElementById("recording-file-hidden");
    const dt = new DataTransfer();
    dt.items.add(new File([blob], "recording.wav", { type: "audio/wav" }));
    fileInput.files = dt.files;
  });

  // AudioBuffer → WAV Blob
  function audioBufferToWavBlob(audioBuffer) {
    const out = [];
    for (let ch = 0; ch < audioBuffer.numberOfChannels; ch++) {
      out.push(Float32Array.from(audioBuffer.getChannelData(ch)));
    }
    return encodeAudio(out, { sampleRate: audioBuffer.sampleRate });
  }
});
</script>
