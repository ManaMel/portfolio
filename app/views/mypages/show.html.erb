<%= render 'layouts/header' %>
<div class="absolute top-4 right-4 space-x-2">
  <%= link_to "録音ページへ", recordings_path, class: "btn btn-info" %>
  <%= link_to "ログアウト", destroy_user_session_path, data: { turbo_method: :delete }, class: "btn btn-success" %>
</div>

<div class="max-w-3xl mx-auto mt-8 space-y-6 text-green-900 text-lg text-center items-center">
  <h2 class="text-2xl font-bold mb-4">あなたの録音一覧</h2>

  <% @recordings.each do |recording| %>
    <div id="recording_<%= recording.id %>" class="p-4 bg-base-200 rounded-xl shadow mb-6">

      <h3 class="text-xl font-semibold"><%= recording.title %></h3>

      <!-- 録音全消し -->
      <%= link_to recording_path(recording),
          data: { turbo_method: :delete, turbo_confirm: "録音をすべて削除しますか？" } do %>
        <%= render "shared/icon_buttons/delete_button" %>
        <span class="ml-1">削除</span>
      <% end %>


      <!-- 元の録音 -->
      <% if recording.original_audio.attached? %>
        <audio controls class="mt-1 w-full">
          <source src="<%= url_for(recording.original_audio) %>">
        </audio>

        <%= link_to destroy_original_recording_path(recording),
            data: { turbo_method: :delete, turbo_confirm: "削除しますか？" } do %>
          <%= render "shared/icon_buttons/delete_button" %>
          <span class="ml-1">元音声削除</span>
        <% end %>
      <% end %>


      <!-- 伴奏 -->
      <% if recording.accompaniment.attached? %>
        <audio controls class="mt-1 w-full">
          <source src="<%= url_for(recording.accompaniment) %>">
        </audio>

        <%= link_to destroy_accompaniment_recording_path(recording),
            data: { turbo_method: :delete, turbo_confirm: "削除しますか？" } do %>
          <%= render "shared/icon_buttons/delete_button" %>
          <span class="ml-1">伴奏削除</span>
        <% end %>

      <% else %>
        <%= link_to "伴奏を選ぶ", select_accompaniment_recording_path(recording), class: "btn btn-sm btn-info mt-2" %>
      <% end %>


      <!-- ステータス表示 -->
      <% if recording.generating? %>
        <p class="mt-3 text-yellow-600 font-semibold">音声を生成中です…</p>
        <button onclick="location.reload()" class="btn btn-sm btn-outline mt-1">生成状況を確認する</button>

      <% elsif recording.generated? && !recording.generated_audio.attached? %>
        <p class="mt-3 text-green-600 font-semibold">
          生成が完了しました。
          <%= link_to "更新して確認する", request.original_url, class: "btn btn-sm btn-outline mt-1" %>
        </p>
      <% end %>


      <!-- ミックス済み音声 -->
      <% if recording.generated_audio.attached? %>
        <p class="font-bold mt-4">ミックス済み音声</p>
        <audio controls class="mt-2 w-full">
          <source src="<%= url_for(recording.generated_audio) %>" type="<%= recording.generated_audio.content_type %>">
        </audio>

        <%= link_to destroy_generated_recording_path(recording),
            data: { turbo_method: :delete, turbo_confirm: "削除しますか？" } do %>
          <%= render "shared/icon_buttons/delete_button" %>
          <span class="ml-1">生成音削除</span>
        <% end %>
      <% end %>


      <!-- 音声生成 -->
      <%= form_with url: generate_audio_recording_path(recording), method: :post, local: true do %>
        <% if recording.generated_audio.attached? %>
          <%= submit_tag "再生成する", class: "btn btn-sm btn-warning mt-2" %>
        <% else %>
          <%= submit_tag "音声を生成する", class: "btn btn-primary btn-sm mt-2" %>
        <% end %>
      <% end %>

    </div>
  <% end %>
</div>
