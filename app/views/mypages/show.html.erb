<%= render 'layouts/header' %>

<div class="absolute top-4 right-4 space-x-2">
  <%= link_to "録音する", recordings_path, class: "btn btn-primary" %>
  <%= link_to "ログアウト", destroy_user_session_path, data: { turbo_method: :delete }, class: "btn btn-success" %>
</div>

<div class="max-w-4xl mx-auto mt-8 space-y-6 p-4">
  
  <h1 class="text-3xl font-bold text-center mb-8 text-green-900">マイページ</h1>

  <%# Flash メッセージ表示 %>
  <% if notice %>
    <div class="alert alert-success shadow-lg mb-4">
      <div>
        <span><%= notice %></span>
      </div>
    </div>
  <% end %>

  <% if alert %>
    <div class="alert alert-error shadow-lg mb-4">
      <div>
        <span><%= alert %></span>
      </div>
    </div>
  <% end %>

  <%# 録音一覧 %>
  <div class="space-y-4">
    <h2 class="text-2xl font-bold mb-4 text-green-800">あなたの録音一覧</h2>
    
    <% if @recordings && @recordings.any? %>
      <div class="grid gap-4">
        <% @recordings.each do |recording| %>
          <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow duration-300">
            <div class="card-body">
              <h3 class="card-title text-xl">
                <%= recording.title %>
                <span class="badge badge-sm <%= recording.accompaniment.attached? ? 'badge-success' : 'badge-warning' %>">
                  <%= recording.accompaniment.attached? ? '✓ 伴奏あり' : '⚠ 伴奏なし' %>
                </span>
              </h3>
              
              <div class="text-sm text-gray-600 space-y-1">
              <% if recording.generated_audio.attached? %>
                <div class="mt-4 p-4 bg-green-50 rounded-lg border border-green-200">
                  <p class="font-semibold text-green-800 mb-2">完成したミックス音源</p>

                  <audio controls class="w-full">
                    <source src="<%= url_for(recording.generated_audio) %>" type="audio/mpeg">
                    お使いのブラウザは audio タグに対応していません。
                 </audio>

                 <p class="text-xs text-gray-600 mt-1">
                   ファイル名: <%= recording.generated_audio.filename %>  
                   (<%= number_to_human_size(recording.generated_audio.byte_size) %>)
                 </p>
               </div>
             <% end %>

                <p>作成日時: <%= recording.created_at.strftime('%Y年%m月%d日 %H:%M') %></p>
                <p>ステータス: <span class="font-semibold"><%= recording.status %></span></p>
                <p>
                  録音: <%= recording.original_audio.attached? ? '✓ あり' : '✗ なし' %> 
                  <% if recording.original_audio.attached? %>
                    <span class="text-xs text-gray-500">(<%= number_to_human_size(recording.original_audio.byte_size) %>)</span>
                  <% end %>
                </p>
                <p>
                  伴奏: <%= recording.accompaniment.attached? ? '✓ あり' : '✗ なし' %>
                  <% if recording.accompaniment.attached? %>
                    <span class="text-xs text-gray-500">(<%= recording.accompaniment.filename %>)</span>
                  <% end %>
                </p>
              </div>

              <div class="card-actions justify-end mt-4 space-x-2">
                <% if recording.accompaniment.attached? %>
                  <%# 伴奏がある場合は調整ページへ %>
                  <%= link_to recording_path(recording), class: "btn btn-primary btn-sm" do %>
                    <span class="mr-1"></span>タイミング調整
                  <% end %>
                <% else %>
                  <%# 伴奏がない場合は選択ページへ %>
                  <%= link_to select_accompaniment_recording_path(recording), class: "btn btn-warning btn-sm" do %>
                    <span class="mr-1"></span>伴奏をアップロード
                  <% end %>
                <% end %>
                
                <%= link_to recording_path(recording), 
                    data: { turbo_method: :delete, turbo_confirm: "「#{recording.title}」を削除しますか？" }, 
                    class: "btn btn-error btn-sm" do %>
                  <span class="mr-1"></span>削除
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="text-center p-8 bg-gray-50 rounded-lg shadow-md">
        <p class="text-xl text-gray-500 mb-4">まだ録音がありません</p>
        <p class="text-gray-400 mb-6">最初の録音を作成してみましょう！</p>
        <%= link_to new_recording_path, class: "btn btn-primary btn-lg" do %>
          <span class="mr-2"></span>最初の録音を作成
        <% end %>
      </div>
    <% end %>
  </div>

</div>