#!/bin/bash -e

# =================================================================
# 1. 初期設定 (元のロジック)
# =================================================================

# Enable jemalloc for reduced memory usage and latency.
if [ -z "${LD_PRELOAD+x}" ] && [ -f /usr/lib/*/libjemalloc.so.2 ]; then
  export LD_PRELOAD="$(echo /usr/lib/*/libjemalloc.so.2)"
fi


# =================================================================
# 2. 【重要】Bundlerのパスを強制的に設定 (GemNotFound対策)
#    - C拡張が見つからない警告 (missing extensions) を解決するため、
#      LD_LIBRARY_PATHと実行バイナリPATHを/rails配下に強制します。
# =================================================================

# Gemインストール先ディレクトリのベースパス (Dockerfileで定義したパス)
GEM_BASE_DIR="/rails/vendor/bundle/ruby"

# /rails/vendor/bundle/ruby/ にある最初のRubyバージョンディレクトリを取得 (例: 3.3.0)
RUBY_VERSION_DIR=$(find "${GEM_BASE_DIR}" -maxdepth 1 -mindepth 1 -type d -name "3.*" -exec basename {} \;)

if [ -z "$RUBY_VERSION_DIR" ]; then
    echo "Error: Could not find Ruby version directory in ${GEM_BASE_DIR}. Aborting path setup."
    # デバッグ情報としてディレクトリ構造を表示
    ls -lR /rails/vendor/bundle
else
    # Gemがインストールされた正確なパスを設定
    GEM_HOME="/rails/vendor/bundle"
    BUNDLE_PATH="${GEM_HOME}"
    GEM_BIN_DIR="${GEM_HOME}/ruby/${RUBY_VERSION_DIR}/bin"
    # ネイティブ拡張 (.so ファイル) の場所
    GEM_EXT_DIR="${GEM_BASE_DIR}/${RUBY_VERSION_DIR}/extensions/x86_64-linux"

    # 環境変数をエクスポート
    # PATHにGemの実行ファイルディレクトリを追加
    export PATH="${GEM_BIN_DIR}:${PATH}"
    # 【最重要】ネイティブ拡張の場所を動的リンカーに通知
    export LD_LIBRARY_PATH="${GEM_EXT_DIR}:${LD_LIBRARY_PATH}"
    # Bundlerの設定を上書き
    export GEM_HOME="${GEM_HOME}"
    export BUNDLE_PATH="${BUNDLE_PATH}"

    echo "--- Dynamic Bundler Environment Setup Complete ---"
    echo "GEM_HOME: ${GEM_HOME}"
    echo "PATH starts with: ${GEM_BIN_DIR}"
    echo "LD_LIBRARY_PATH starts with: ${GEM_EXT_DIR}"
    echo "------------------------------------------------"
fi


# =================================================================
# 3. DBの準備 (元のロジック)
# =================================================================

# If running the rails server then create or migrate existing database
if [ "${1}" == "./bin/rails" ] && [ "${2}" == "server" ]; then
  ./bin/rails db:prepare
fi

# =================================================================
# 4. 最終的なコマンドを実行
# =================================================================

# 環境変数が設定された状態で、CMDで渡されたコマンドを実行
exec "${@}"