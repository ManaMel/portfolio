#!/bin/bash -e

# =================================================================
# 1. 環境変数の初期設定とパスの強制設定
# =================================================================

# Gemインストール先ディレクトリのベースパス
GEM_BASE_DIR="/rails/vendor/bundle/ruby"

# Rubyバージョンディレクトリを取得 (例: 3.3.0)
RUBY_VERSION_DIR=$(find "${GEM_BASE_DIR}" -maxdepth 1 -mindepth 1 -type d -name "3.*" -exec basename {} \;)

if [ -z "$RUBY_VERSION_DIR" ]; then
    echo "--- FATAL ERROR: Ruby version directory not found in ${GEM_BASE_DIR}! ---"
    exit 1  # 起動を停止
fi

# Gemの実行バイナリ (puma, sidekiq, rails) があるディレクトリ
GEM_BIN_DIR="${GEM_BASE_DIR}/${RUBY_VERSION_DIR}/bin"

# ネイティブ拡張 (.so ファイル) の場所を検索
GEM_EXT_BASE_DIR="${GEM_BASE_DIR}/${RUBY_VERSION_DIR}/extensions/x86_64-linux"
# 実際の拡張ディレクトリ（ハッシュ名を持つディレクトリ）を見つける
GEM_EXT_DIR=$(find "${GEM_EXT_BASE_DIR}" -maxdepth 1 -mindepth 1 -type d | head -n 1)

if [ -z "$GEM_EXT_DIR" ]; then
    echo "--- WARNING: Specific C-Extensions directory not found. Falling back to base path. ---"
    GEM_EXT_DIR="${GEM_EXT_BASE_DIR}"
fi

# Gem Binariesディレクトリが存在するかチェック (puma: command not found の原因究明)
if [ ! -d "$GEM_BIN_DIR" ]; then
    echo "--- FATAL ERROR: Gem binary directory not found at ${GEM_BIN_DIR}! Cannot run Puma/Sidekiq. ---"
    exit 1
fi

# 環境変数をエクスポート (PATHとLD_LIBRARY_PATHの設定が最重要)
export PATH="${GEM_BIN_DIR}:${PATH}"
export LD_LIBRARY_PATH="${GEM_EXT_DIR}:${LD_LIBRARY_PATH}"

# Bundlerの設定を上書き
export GEM_HOME="/rails/vendor/bundle"
export BUNDLE_PATH="/rails/vendor/bundle"

echo "--- Dynamic Bundler Environment Setup Complete ---"
echo "GEM_BIN_DIR: ${GEM_BIN_DIR}"
echo "LD_LIBRARY_PATH starts with: ${GEM_EXT_DIR}"
which ${1} 2>/dev/null || echo "CHECK: Command '${1}' status: $? (should be 0 for success)"
echo "------------------------------------------------"


# =================================================================
# 2. その他の初期化 (DBの準備など)
# =================================================================

# Enable jemalloc 
if [ -z "${LD_PRELOAD+x}" ] && [ -f /usr/lib/*/libjemalloc.so.2 ]; then
  export LD_PRELOAD="$(echo /usr/lib/*/libjemalloc.so.2)"
fi

# DBの準備 (Web Serviceのみで実行される)
if [ "${1}" == "puma" ]; then
  # pumaが起動する前に db:prepare を実行
  /rails/vendor/bundle/bin/rake db:prepare
fi

# =================================================================
# 3. 最終的なコマンドを実行
# =================================================================

# 環境変数が設定された状態で、CMDで渡されたコマンドを実行
exec "${@}"